name: ğŸ§¹ ä»“åº“æ¸…ç†

on:
  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹ï¼ˆUTCæ—¶é—´ï¼‰è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 2 * * 1'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: write # åˆ é™¤Releaseéœ€è¦å†™æƒé™
  actions: read   # è¯»å–Artifactsåˆ—è¡¨éœ€è¦è¯»æƒé™

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          # è®¾ç½®ä¿ç•™å¤©æ•°ï¼Œå¯åœ¨æ­¤ä¿®æ”¹
          echo "DAYS_TO_KEEP=30" >> $GITHUB_ENV

      - name: ğŸ§¹ æ¸…ç†æ—§çš„ Releases
        run: |
          echo "ğŸ§¹ å¼€å§‹æ¸…ç†è¶…è¿‡ ${{ env.DAYS_TO_KEEP }} å¤©çš„ Releases..."
          # å®‰è£…gh cli
          sudo apt-get update && sudo apt-get install -y jq
          # ç™»å½•gh cli
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # è·å–æ‰€æœ‰Releasesï¼Œç­›é€‰å‡ºè¶…è¿‡ä¿ç•™å¤©æœŸçš„ï¼Œå¹¶åˆ é™¤
          gh release list --limit 500 --json tagName,createdAt | \
          jq -r --arg days ${{ env.DAYS_TO_KEEP }} \
          '.[] | select (.createdAt < (now - ($days | tonumber) * 24 * 3600 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | .tagName' | \
          while read -r tag; do
            if [ -n "$tag" ]; then
              echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤ Release: $tag"
              gh release delete "$tag" --yes
              echo "âœ… å·²åˆ é™¤ Release: $tag"
            fi
          done
          echo "âœ… Releases æ¸…ç†å®Œæˆ"

      - name: ğŸ§¹ æ¸…ç†æ—§çš„ Artifacts
        # æ³¨æ„ï¼šåˆ é™¤Artifactséœ€è¦actions: writeæƒé™ï¼Œä½†ä¸ºäº†å®‰å…¨ï¼Œè¿™é‡Œåªè¯»å–å¹¶æ‰“å°ä¿¡æ¯
        # å®é™…åˆ é™¤æ“ä½œå·²åœ¨release.ymlä¸­å®Œæˆï¼Œæˆ–å¯ä»¥å•ç‹¬æˆäºˆæ›´é«˜æƒé™åæ‰§è¡Œ
        run: |
          echo "ğŸ§¹ å¼€å§‹æ£€æŸ¥è¶…è¿‡ ${{ env.DAYS_TO_KEEP }} å¤©çš„ Artifacts..."
          # å®‰è£…gh cli
          sudo apt-get update && sudo apt-get install -y jq
          # ç™»å½•gh cli
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # åˆ—å‡ºæ‰€æœ‰æ—§çš„Artifactsï¼ˆä»…ç”¨äºæŸ¥çœ‹ï¼‰
          gh api repos/:owner/:repo/actions/artifacts --jq '.artifacts[] | select(.created_at < (now - (${{ env.DAYS_TO_KEEP }} | tonumber) * 24 * 3600 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | {name: .name, created_at: .created_at, size_in_bytes: .size_in_bytes}'
          echo "â„¹ï¸ å·²åˆ—å‡ºæ‰€æœ‰æ—§çš„Artifactsã€‚å®é™…åˆ é™¤æ“ä½œè¯·åœ¨ release.yml ä¸­é…ç½®æˆ–ä¸ºæ­¤å·¥ä½œæµèµ‹äºˆ actions: write æƒé™ã€‚"
