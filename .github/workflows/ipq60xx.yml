name: OpenWrt Multi-Branch Build (Layered)

on:
  schedule:
    # 北京时间每周五0点 (UTC时间周四16点)
    - cron: '0 16 * * 4'
  workflow_dispatch:
    inputs:
      branch_filter:
        description: '选择要编译的分支 (留空编译全部)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - openwrt
          - immwrt
          - libwrt
      config_filter:
        description: '选择配置类型 (留空编译全部)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - Ultra
          - Max
          - Pro

env:
  # 图标定义
  ICON_SUCCESS: "✅"
  ICON_ERROR: "❌"
  ICON_WARNING: "⚠️"
  ICON_INFO: "ℹ️"
  ICON_START: "🚀"
  ICON_END: "🏁"
  ICON_PROGRESS: "⏳"
  ICON_DEBUG: "🔍"
  ICON_CONFIG: "⚙️"
  ICON_PACKAGE: "📦"
  ICON_CACHE: "💾"
  ICON_BUILD: "🔨"
  ICON_CLEAN: "🧹"
  # 基础环境变量
  TZ: Asia/Shanghai
  DIY_P1_SH: scripts/diy.sh
  UPLOAD_BIN_DIR: ./upload

jobs:
  # 作业1: 设置环境，提取设备信息，生成动态编译矩阵
  setup:
    runs-on: ubuntu-22.04
    outputs:
      devices: ${{ steps.extract-devices.outputs.devices }}
      # 输出三个阶段的矩阵
      matrix-ultra: ${{ steps.generate-matrix.outputs.matrix-ultra }}
      matrix-max: ${{ steps.generate-matrix.outputs.matrix-max }}
      matrix-pro: ${{ steps.generate-matrix.outputs.matrix-pro }}
      build-date: ${{ steps.get-date.outputs.date }}
    steps:
      - name: ${{ env.ICON_START }} 检出代码
        uses: actions/checkout@v4

      - name: ${{ env.ICON_CONFIG }} 提取设备列表
        id: extract-devices
        run: |
          echo -e "${ICON_PROGRESS} 正在从 configs/base_ipq60xx.config 提取设备列表..."
          DEVICES=$(grep -oE 'CONFIG_TARGET_DEVICE_.*_DEVICE_([^=]+)=y' configs/base_ipq60xx.config | sed -E 's/CONFIG_TARGET_DEVICE_.*_DEVICE_([^=]+)=y/\1/' | sort -u | tr '\n' ' ')
          if [ -z "$DEVICES" ]; then
            echo -e "${ICON_ERROR} 错误: 未能从 base_ipq60xx.config 中提取到任何设备名称。"
            exit 1
          fi
          echo -e "${ICON_INFO} 发现设备: ${DEVICES}"
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT

      - name: ${{ env.ICON_CONFIG }} 生成动态编译矩阵
        id: generate-matrix
        run: |
          # 从输入中获取用户选择的过滤条件
          BRANCH_FILTER="${{ github.event.inputs.branch_filter || 'all' }}"
          CONFIG_FILTER="${{ github.event.inputs.config_filter || 'all' }}"
          
          # 定义所有分支
          ALL_BRANCHES='[
            {"name": "openwrt", "repo": "https://github.com/laipeng668/openwrt.git", "branch": "master", "short": "openwrt"},
            {"name": "immwrt", "repo": "https://github.com/laipeng668/immortalwrt.git", "branch": "master", "short": "immwrt"},
            {"name": "libwrt", "repo": "https://github.com/laipeng668/openwrt-6.x.git", "branch": "k6.12-nss", "short": "libwrt"}
          ]'
          
          # 定义所有配置
          ALL_CONFIGS='["Ultra", "Max", "Pro"]'
          
          # 生成基础矩阵（所有组合）
          BASE_MATRIX=$(jq -n \
            --argjson branches "$ALL_BRANCHES" \
            --argjson configs "$ALL_CONFIGS" \
            --arg devices "${{ steps.extract-devices.outputs.devices }}" \
            '{
              include: [
                $branches[] | select($branch_filter == "all" or .short == $branch_filter) as $branch |
                $configs[] | select($config_filter == "all" or . == $config_filter) as $config |
                ($devices | split(" ") | map(select(length > 0)))[] as $device |
                {branch: $branch, config: $config, device: $device}
              ]
            }')
          
          # 分离不同配置的矩阵
          MATRIX_ULTRA=$(echo "$BASE_MATRIX" | jq '{include: [.include[] | select(.config == "Ultra")]}')
          MATRIX_MAX=$(echo "$BASE_MATRIX" | jq '{include: [.include[] | select(.config == "Max")]}')
          MATRIX_PRO=$(echo "$BASE_MATRIX" | jq '{include: [.include[] | select(.config == "Pro")]}')
          
          # 输出矩阵（确保格式正确）
          echo "matrix-ultra=$(echo "$MATRIX_ULTRA" | jq -c .)" >> $GITHUB_OUTPUT
          echo "matrix-max=$(echo "$MATRIX_MAX" | jq -c .)" >> $GITHUB_OUTPUT
          echo "matrix-pro=$(echo "$MATRIX_PRO" | jq -c .)" >> $GITHUB_OUTPUT
          
          echo -e "${ICON_INFO} Ultra 矩阵:"
          echo "$MATRIX_ULTRA" | jq .
          echo -e "${ICON_INFO} Max 矩阵:"
          echo "$MATRIX_MAX" | jq .
          echo -e "${ICON_INFO} Pro 矩阵:"
          echo "$MATRIX_PRO" | jq .

      - name: ${{ env.ICON_INFO }} 获取构建日期
        id: get-date
        run: |
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

  # 第一阶段: 编译 Ultra 配置
  build-ultra:
    needs: setup
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix-ultra) }}
    
    steps:
      - name: ${{ env.ICON_START }} 检出代码
        uses: actions/checkout@v4

      - name: ${{ env.ICON_CACHE }} 缓存源码
        uses: actions/cache@v3
        id: cache-source
        with:
          path: openwrt
          key: ${{ matrix.branch.short }}-source-${{ hashFiles(format('{0}/{1}', github.workspace, '.github/workflows/build.yml')) }}
          restore-keys: |
            ${{ matrix.branch.short }}-source-

      - name: ${{ env.ICON_PACKAGE }} 克隆源码
        if: steps.cache-source.outputs.cache-hit != 'true'
        run: |
          echo -e "${ICON_PROGRESS} 克隆 ${{ matrix.branch.name }} 源码..."
          git clone ${{ matrix.branch.repo }} -b ${{ matrix.branch.branch }} openwrt
          cd openwrt
          echo "源码版本: $(git rev-parse --short HEAD)" > ../source_info.txt
          echo "分支: ${{ matrix.branch.branch }}" >> ../source_info.txt
          echo -e "${ICON_SUCCESS} 源码克隆完成"

      - name: ${{ env.ICON_CACHE }} 缓存 Ultra 层级
        uses: actions/cache@v3
        id: cache-ultra
        with:
          path: |
            openwrt/staging_dir
            openwrt/build_dir
            openwrt/feeds
            openwrt/dl
          # Ultra 缓存键，包含所有配置
          key: ${{ matrix.branch.short }}-ultra-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Ultra.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
          restore-keys: |
            ${{ matrix.branch.short }}-ultra-
            ${{ matrix.branch.short }}-tools-

      - name: ${{ env.ICON_CONFIG }} 合并 Ultra 配置
        run: |
          echo -e "${ICON_PROGRESS} 合并 Ultra 配置: ${{ matrix.branch.short }}-${{ matrix.device }}-Ultra"
          # 创建临时目录
          mkdir -p temp_config
          
          # 按优先级合并配置
          cat configs/base_ipq60xx.config > temp_config/merged.config
          cat configs/base_${{ matrix.branch.short }}.config >> temp_config/merged.config
          cat configs/Ultra.config >> temp_config/merged.config
          
          # 提取设备配置
          DEVICE_CONFIG_LINE=$(grep -E "CONFIG_TARGET_DEVICE.*_${{ matrix.device }}=y" temp_config/merged.config || true)
          if [ -z "$DEVICE_CONFIG_LINE" ]; then
            echo -e "${ICON_ERROR} 错误: 设备 '${{ matrix.device }}' 在配置中未找到"
            exit 1
          fi
          
          # 生成最终配置
          cat > openwrt/.config << EOF
          CONFIG_TARGET_${{ matrix.branch.short }}=y
          CONFIG_TARGET_${{ matrix.branch.short }}_ipq60xx=y
          CONFIG_TARGET_MULTI_PROFILE=y
          $DEVICE_CONFIG_LINE
          EOF
          
          # 添加其他配置
          grep -vE "CONFIG_TARGET_DEVICE" temp_config/merged.config >> openwrt/.config
          sort -u openwrt/.config -o openwrt/.config
          
          echo -e "${ICON_SUCCESS} Ultra 配置合并完成"

      - name: ${{ env.ICON_PACKAGE }} 更新和安装Feeds
        if: steps.cache-ultra.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          echo -e "${ICON_PROGRESS} 更新 feeds..."
          ./scripts/feeds update -a
          echo -e "${ICON_PROGRESS} 安装 feeds..."
          ./scripts/feeds install -a
          echo -e "${ICON_SUCCESS} Feeds 处理完成"

      - name: ${{ env.ICON_BUILD }} 执行DIY脚本
        if: steps.cache-ultra.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          chmod +x ../${{ env.DIY_P1_SH }}
          ../${{ env.DIY_P1_SH }} ${{ matrix.branch.short }} ipq60xx

      - name: ${{ env.ICON_BUILD }} 下载工具链和依赖
        if: steps.cache-ultra.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -exec rm -f {} \;

      - name: ${{ env.ICON_BUILD }} 编译 Ultra 固件
        id: compile
        run: |
          cd openwrt
          echo -e "${ICON_BUILD} 编译 Ultra 固件 (使用 $(nproc) 个线程)..."
          make -j$(nproc) || make -j1 V=s
          echo -e "${ICON_SUCCESS} Ultra 固件编译完成"
          
          # 获取内核版本
          KERNEL_VERSION=$(grep "CONFIG_LINUX_VERSION=" .config | cut -d'"' -f2)
          echo "kernel_version=$KERNEL_VERSION" >> $GITHUB_OUTPUT

      - name: ${{ env.ICON_PACKAGE }} 整理 Ultra 产出物
        id: organize
        run: |
          echo -e "${ICON_PROGRESS} 整理 Ultra 产出物..."
          TEMP_BUILD_DIR="build_artifacts/${{ matrix.branch.short }}-${{ matrix.device }}-Ultra"
          mkdir -p "$TEMP_BUILD_DIR"
          
          # 复制固件
          find openwrt/bin/targets/ -name "*${{ matrix.device }}*squashfs*" -type f | while read -r file; do
            if [[ "$file" == *factory.bin || "$file" == *sysupgrade.bin ]]; then
              FILE_TYPE=$(basename "$file" | grep -oE "(factory|sysupgrade)")
              NEW_NAME="${{ matrix.branch.short }}-${{ matrix.device }}-${FILE_TYPE}-Ultra.bin"
              cp "$file" "$TEMP_BUILD_DIR/$NEW_NAME"
              echo -e "${ICON_PACKAGE} 固件: $NEW_NAME"
            fi
          done
          
          # 复制配置文件
          cp openwrt/.config "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Ultra.config"
          cp openwrt/bin/targets/*/manifest "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Ultra.manifest" 2>/dev/null || true
          cp openwrt/config.buildinfo "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Ultra.config.buildinfo" 2>/dev/null || true
          
          # 收集IPK包
          mkdir -p "packages_temp/${{ matrix.branch.short }}"
          find openwrt/bin/packages/ -name "*.ipk" -exec cp {} "packages_temp/${{ matrix.branch.short }}/" \; 2>/dev/null || true
          
          echo "temp_dir=$TEMP_BUILD_DIR" >> $GITHUB_OUTPUT

      - name: ${{ env.ICON_CACHE }} 上传 Ultra 构建产物
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.branch.short }}-${{ matrix.device }}-Ultra
          path: ${{ steps.organize.outputs.temp_dir }}
          retention-days: 7

  # 第二阶段: 编译 Max 配置
  build-max:
    needs: [setup, build-ultra]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix-max) }}
    
    steps:
      - name: ${{ env.ICON_START }} 检出代码
        uses: actions/checkout@v4

      - name: ${{ env.ICON_CACHE }} 缓存源码
        uses: actions/cache@v3
        id: cache-source
        with:
          path: openwrt
          key: ${{ matrix.branch.short }}-source-${{ hashFiles(format('{0}/{1}', github.workspace, '.github/workflows/build.yml')) }}
          restore-keys: |
            ${{ matrix.branch.short }}-source-

      - name: ${{ env.ICON_CACHE }} 复用 Ultra 缓存
        uses: actions/cache@v3
        id: cache-max
        with:
          path: |
            openwrt/staging_dir
            openwrt/build_dir
            openwrt/feeds
            openwrt/dl
          # Max 缓存键，复用 Ultra 缓存
          key: ${{ matrix.branch.short }}-max-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Max.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
          restore-keys: |
            ${{ matrix.branch.short }}-ultra-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Ultra.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
            ${{ matrix.branch.short }}-ultra-
            ${{ matrix.branch.short }}-tools-

      - name: ${{ env.ICON_CONFIG }} 合并 Max 配置
        run: |
          echo -e "${ICON_PROGRESS} 合并 Max 配置: ${{ matrix.branch.short }}-${{ matrix.device }}-Max"
          mkdir -p temp_config
          
          # 按优先级合并配置
          cat configs/base_ipq60xx.config > temp_config/merged.config
          cat configs/base_${{ matrix.branch.short }}.config >> temp_config/merged.config
          cat configs/Max.config >> temp_config/merged.config
          
          # 提取设备配置
          DEVICE_CONFIG_LINE=$(grep -E "CONFIG_TARGET_DEVICE.*_${{ matrix.device }}=y" temp_config/merged.config || true)
          if [ -z "$DEVICE_CONFIG_LINE" ]; then
            echo -e "${ICON_ERROR} 错误: 设备 '${{ matrix.device }}' 在配置中未找到"
            exit 1
          fi
          
          # 生成最终配置
          cat > openwrt/.config << EOF
          CONFIG_TARGET_${{ matrix.branch.short }}=y
          CONFIG_TARGET_${{ matrix.branch.short }}_ipq60xx=y
          CONFIG_TARGET_MULTI_PROFILE=y
          $DEVICE_CONFIG_LINE
          EOF
          
          # 添加其他配置
          grep -vE "CONFIG_TARGET_DEVICE" temp_config/merged.config >> openwrt/.config
          sort -u openwrt/.config -o openwrt/.config
          
          echo -e "${ICON_SUCCESS} Max 配置合并完成"

      - name: ${{ env.ICON_BUILD }} 执行DIY脚本
        if: steps.cache-max.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          chmod +x ../${{ env.DIY_P1_SH }}
          ../${{ env.DIY_P1_SH }} ${{ matrix.branch.short }} ipq60xx

      - name: ${{ env.ICON_BUILD }} 编译 Max 固件
        id: compile
        run: |
          cd openwrt
          echo -e "${ICON_BUILD} 编译 Max 固件 (复用 Ultra 缓存)..."
          make defconfig
          make -j$(nproc) || make -j1 V=s
          echo -e "${ICON_SUCCESS} Max 固件编译完成"

      - name: ${{ env.ICON_PACKAGE }} 整理 Max 产出物
        id: organize
        run: |
          echo -e "${ICON_PROGRESS} 整理 Max 产出物..."
          TEMP_BUILD_DIR="build_artifacts/${{ matrix.branch.short }}-${{ matrix.device }}-Max"
          mkdir -p "$TEMP_BUILD_DIR"
          
          # 复制固件
          find openwrt/bin/targets/ -name "*${{ matrix.device }}*squashfs*" -type f | while read -r file; do
            if [[ "$file" == *factory.bin || "$file" == *sysupgrade.bin ]]; then
              FILE_TYPE=$(basename "$file" | grep -oE "(factory|sysupgrade)")
              NEW_NAME="${{ matrix.branch.short }}-${{ matrix.device }}-${FILE_TYPE}-Max.bin"
              cp "$file" "$TEMP_BUILD_DIR/$NEW_NAME"
              echo -e "${ICON_PACKAGE} 固件: $NEW_NAME"
            fi
          done
          
          # 复制配置文件
          cp openwrt/.config "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Max.config"
          cp openwrt/bin/targets/*/manifest "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Max.manifest" 2>/dev/null || true
          cp openwrt/config.buildinfo "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Max.config.buildinfo" 2>/dev/null || true
          
          echo "temp_dir=$TEMP_BUILD_DIR" >> $GITHUB_OUTPUT

      - name: ${{ env.ICON_CACHE }} 上传 Max 构建产物
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.branch.short }}-${{ matrix.device }}-Max
          path: ${{ steps.organize.outputs.temp_dir }}
          retention-days: 7

  # 第三阶段: 编译 Pro 配置
  build-pro:
    needs: [setup, build-max]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix-pro) }}
    
    steps:
      - name: ${{ env.ICON_START }} 检出代码
        uses: actions/checkout@v4

      - name: ${{ env.ICON_CACHE }} 缓存源码
        uses: actions/cache@v3
        id: cache-source
        with:
          path: openwrt
          key: ${{ matrix.branch.short }}-source-${{ hashFiles(format('{0}/{1}', github.workspace, '.github/workflows/build.yml')) }}
          restore-keys: |
            ${{ matrix.branch.short }}-source-

      - name: ${{ env.ICON_CACHE }} 复用 Max 缓存
        uses: actions/cache@v3
        id: cache-pro
        with:
          path: |
            openwrt/staging_dir
            openwrt/build_dir
            openwrt/feeds
            openwrt/dl
          # Pro 缓存键，复用 Max 缓存
          key: ${{ matrix.branch.short }}-pro-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Pro.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
          restore-keys: |
            ${{ matrix.branch.short }}-max-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Max.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
            ${{ matrix.branch.short }}-ultra-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Ultra.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
            ${{ matrix.branch.short }}-ultra-
            ${{ matrix.branch.short }}-max-
            ${{ matrix.branch.short }}-tools-

      - name: ${{ env.ICON_CONFIG }} 合并 Pro 配置
        run: |
          echo -e "${ICON_PROGRESS} 合并 Pro 配置: ${{ matrix.branch.short }}-${{ matrix.device }}-Pro"
          mkdir -p temp_config
          
          # 按优先级合并配置
          cat configs/base_ipq60xx.config > temp_config/merged.config
          cat configs/base_${{ matrix.branch.short }}.config >> temp_config/merged.config
          cat configs/Pro.config >> temp_config/merged.config
          
          # 提取设备配置
          DEVICE_CONFIG_LINE=$(grep -E "CONFIG_TARGET_DEVICE.*_${{ matrix.device }}=y" temp_config/merged.config || true)
          if [ -z "$DEVICE_CONFIG_LINE" ]; then
            echo -e "${ICON_ERROR} 错误: 设备 '${{ matrix.device }}' 在配置中未找到"
            exit 1
          fi
          
          # 生成最终配置
          cat > openwrt/.config << EOF
          CONFIG_TARGET_${{ matrix.branch.short }}=y
          CONFIG_TARGET_${{ matrix.branch.short }}_ipq60xx=y
          CONFIG_TARGET_MULTI_PROFILE=y
          $DEVICE_CONFIG_LINE
          EOF
          
          # 添加其他配置
          grep -vE "CONFIG_TARGET_DEVICE" temp_config/merged.config >> openwrt/.config
          sort -u openwrt/.config -o openwrt/.config
          
          echo -e "${ICON_SUCCESS} Pro 配置合并完成"

      - name: ${{ env.ICON_BUILD }} 执行DIY脚本
        if: steps.cache-pro.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          chmod +x ../${{ env.DIY_P1_SH }}
          ../${{ env.DIY_P1_SH }} ${{ matrix.branch.short }} ipq60xx

      - name: ${{ env.ICON_BUILD }} 编译 Pro 固件
        id: compile
        run: |
          cd openwrt
          echo -e "${ICON_BUILD} 编译 Pro 固件 (复用 Max 缓存)..."
          make defconfig
          make -j$(nproc) || make -j1 V=s
          echo -e "${ICON_SUCCESS} Pro 固件编译完成"

      - name: ${{ env.ICON_PACKAGE }} 整理 Pro 产出物
        id: organize
        run: |
          echo -e "${ICON_PROGRESS} 整理 Pro 产出物..."
          TEMP_BUILD_DIR="build_artifacts/${{ matrix.branch.short }}-${{ matrix.device }}-Pro"
          mkdir -p "$TEMP_BUILD_DIR"
          
          # 复制固件
          find openwrt/bin/targets/ -name "*${{ matrix.device }}*squashfs*" -type f | while read -r file; do
            if [[ "$file" == *factory.bin || "$file" == *sysupgrade.bin ]]; then
              FILE_TYPE=$(basename "$file" | grep -oE "(factory|sysupgrade)")
              NEW_NAME="${{ matrix.branch.short }}-${{ matrix.device }}-${FILE_TYPE}-Pro.bin"
              cp "$file" "$TEMP_BUILD_DIR/$NEW_NAME"
              echo -e "${ICON_PACKAGE} 固件: $NEW_NAME"
            fi
          done
          
          # 复制配置文件
          cp openwrt/.config "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Pro.config"
          cp openwrt/bin/targets/*/manifest "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Pro.manifest" 2>/dev/null || true
          cp openwrt/config.buildinfo "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Pro.config.buildinfo" 2>/dev/null || true
          
          echo "temp_dir=$TEMP_BUILD_DIR" >> $GITHUB_OUTPUT

      - name: ${{ env.ICON_CACHE }} 上传 Pro 构建产物
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.branch.short }}-${{ matrix.device }}-Pro
          path: ${{ steps.organize.outputs.temp_dir }}
          retention-days: 7

  # 作业4: 整理所有产物并发布Release
  release:
    needs: [setup, build-ultra, build-max, build-pro]
    runs-on: ubuntu-22.04
    if: always() && (needs.build-ultra.result == 'success' || needs.build-max.result == 'success' || needs.build-pro.result == 'success')
    steps:
      - name: ${{ env.ICON_START }} 检出代码
        uses: actions/checkout@v4

      - name: ${{ env.ICON_PACKAGE }} 下载所有构建产物
        uses: actions/download-artifact@v3
        with:
          path: all_builds

      - name: ${{ env.ICON_PACKAGE }} 整理发布包
        run: |
          echo -e "${ICON_PROGRESS} 整理最终发布包..."
          
          # 创建发布目录结构
          RELEASE_DIR="release_${{ needs.setup.outputs.build-date }}"
          mkdir -p "$RELEASE_DIR"/{firmware,config,logs,packages}
          
          # 1. 整理固件
          find all_builds -name "*.bin" -type f -exec cp {} "$RELEASE_DIR/firmware/" \;
          
          # 2. 整理配置文件
          find all_builds -name "*.config" -o -name "*.manifest" -o -name "*.config.buildinfo" | while read -r file; do
            cp "$file" "$RELEASE_DIR/config/"
          done
          # 打包配置文件
          cd "$RELEASE_DIR/config"
          tar -czf "../ipq60xx-config.tar.gz" *
          cd - > /dev/null
          
          # 3. 整理软件包
          find all_builds -name "*.ipk" -type f -exec cp {} "$RELEASE_DIR/packages/" \;
          cd "$RELEASE_DIR/packages"
          tar -czf "../ipq60xx-app.tar.gz" *
          cd - > /dev/null
          
          # 4. 创建发布说明
          cat > "$RELEASE_DIR/README.md" << EOF
          # OpenWrt 固件发布 - ${{ needs.setup.outputs.build-date }}
          
          ## 📌 基本信息
          - **默认管理地址**: \`192.168.111.1\`
          - **默认用户**: \`root\`
          - **默认密码**: \`none\` (留空)
          - **默认WIFI密码**: \`12345678\`
          
          ## 📦 固件信息
          - **编译分支**: openwrt, immwrt, libwrt
          - **支持设备**: ${{ needs.setup.outputs.devices }}
          - **配置类型**: Pro (精简), Max (标准), Ultra (完整)
          - **内核版本**: 从固件中获取
          - **作者**: Mary
          - **发布时间**: ${{ needs.setup.outputs.build-date }}
          
          ## 📂 文件说明
          - \`firmware/\`: 各设备各配置的固件文件
          - \`ipq60xx-config.tar.gz\`: 所有设备的配置、清单和构建信息压缩包
          - \`ipq60xx-app.tar.gz\`: 本次编译包含的所有第三方软件包
          
          ## 🏷️ 固件命名规则
          \`分支缩写-设备名称-类型(factory/sysupgrade)-配置(Pro/Max/Ultra).bin\`
          
          ---
          _由 GitHub Actions 自动构建 (分层编译模式)_
          EOF
          
          echo -e "${ICON_SUCCESS} 发布包整理完成"

      - name: ${{ env.ICON_PACKAGE }} 创建GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ipq60xx-${{ needs.setup.outputs.build-date }}
          name: OpenWrt Multi-Branch Build ${{ needs.setup.outputs.build-date }}
          body_path: release_${{ needs.setup.outputs.build-date }}/README.md
          files: |
            release_${{ needs.setup.outputs.build-date }}/firmware/*.bin
            release_${{ needs.setup.outputs.build-date }}/ipq60xx-*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ${{ env.ICON_SUCCESS }} 编译完成通知
        run: |
          echo -e "${ICON_SUCCESS} ${ICON_SUCCESS} ${ICON_SUCCESS}"
          echo -e "所有固件分层编译并发布成功！"
          echo -e "${ICON_INFO} 发布标签: ipq60xx-${{ needs.setup.outputs.build-date }}"
          echo -e "${ICON_INFO} 请访问 Releases 页面下载。"
