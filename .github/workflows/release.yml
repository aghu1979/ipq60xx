name: ğŸš€ OpenWrt å›ºä»¶å‘å¸ƒ

on:
  # å½“ä¸»ç¼–è¯‘å·¥ä½œæµæˆåŠŸå®Œæˆæ—¶ï¼Œè‡ªåŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_run:
    workflows: ["ğŸ”¨ OpenWrt å›ºä»¶ç¼–è¯‘ç³»ç»Ÿ"]
    types:
      - completed
    # åªæœ‰åœ¨ç¼–è¯‘æˆåŠŸæ—¶æ‰æ‰§è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿é‡æ–°å‘å¸ƒ
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: write # åˆ›å»ºReleaseå’Œä¸Šä¼ æ–‡ä»¶éœ€è¦å†™æƒé™

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡
        run: echo "TIMESTAMP=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„download-artifact action
        uses: actions/download-artifact@v4
        with:
          # å°†æ‰€æœ‰äº§ç‰©ä¸‹è½½åˆ° artifacts ç›®å½•
          path: artifacts
          # åˆå¹¶æ‰€æœ‰artifactåˆ°ä¸€ä¸ªç›®å½•
          merge-multiple: true

      - name: ğŸ“¦ å‡†å¤‡å‘å¸ƒå†…å®¹
        run: |
          chmod +x scripts/*.sh
          # è°ƒç”¨å‘å¸ƒè„šæœ¬ï¼Œæ•´ç†äº§ç‰©å¹¶ç”ŸæˆRelease Notes
          ./scripts/release.sh prepare-release

      - name: ğŸš€ åˆ›å»º GitHub Release
        # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„gh-release action
        uses: softprops/action-gh-release@v2
        with:
          # Release Tagï¼Œä¾‹å¦‚ ipq60xx-20231201
          tag_name: ipq60xx-${{ env.TIMESTAMP }}
          # Release æ ‡é¢˜
          name: "OpenWrt å›ºä»¶å‘å¸ƒ - ${{ env.TIMESTAMP }}"
          # Release æ­£æ–‡å†…å®¹ï¼Œä»ç”Ÿæˆçš„markdownæ–‡ä»¶è¯»å–
          body_path: release-notes.md
          # Release æ–‡ä»¶è·¯å¾„
          files: |
            release/*
        env:
          # GitHub Tokenï¼Œç”±Actionsè‡ªåŠ¨æä¾›
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§¹ æ¸…ç†æ—§çš„ Artifacts
        # å‘å¸ƒæˆåŠŸåï¼Œæ¸…ç†æœ¬æ¬¡å·¥ä½œæµäº§ç”Ÿçš„æ—§Artifactsä»¥èŠ‚çœç©ºé—´
        if: success()
        run: |
          echo "ğŸ§¹ å¼€å§‹æ¸…ç†æ—§çš„Artifacts..."
          # å®‰è£…gh cli
          sudo apt-get update && sudo apt-get install -y gh
          # ç™»å½•gh cli
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          # åˆ é™¤è¶…è¿‡7å¤©çš„artifacts
          gh api repos/:owner/:repo/actions/artifacts --jq '.artifacts[] | select(.created_at < (now - 604800 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | .id' | xargs -I {} gh api --method DELETE repos/:owner/:repo/actions/artifacts/{}
          echo "âœ… Artifactsæ¸…ç†å®Œæˆ"
