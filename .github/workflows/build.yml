name: ğŸ”¨ OpenWrt å›ºä»¶ç¼–è¯‘ç³»ç»Ÿ (åˆ†å±‚æ„å»º)

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å‘¨äº”0ç‚¹ (UTCæ—¶é—´å‘¨å››16ç‚¹)
    - cron: '0 16 * * 4'
  workflow_dispatch:
    inputs:
      branch:
        description: 'é€‰æ‹©åˆ†æ”¯ (ç•™ç©ºç¼–è¯‘å…¨éƒ¨)'
        required: false
        type: choice
        options:
          - ''
          - openwrt
          - immwrt
          - libwrt
      config:
        description: 'é€‰æ‹©é…ç½® (ç•™ç©ºç¼–è¯‘å…¨éƒ¨)'
        required: false
        type: choice
        options:
          - ''
          - Pro
          - Max
          - Ultra

env:
  UBUNTU_VERSION: 22.04
  REPO_OPENWRT: https://github.com/openwrt/openwrt.git
  REPO_IMMWRT: https://github.com/immortalwrt/immortalwrt.git
  REPO_LIBWRT: https://github.com/openwrt/openwrt.git

jobs:
  # ========================================
  # é˜¶æ®µä¸€ï¼šå‡†å¤‡å¹¶ç¼“å­˜åŸºç¡€ç¯å¢ƒ
  # ========================================
  prepare-base-environments:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        branch: [openwrt, immwrt, libwrt]
    outputs:
      openwrt-hash: ${{ steps.set_hash.outputs.openwrt-hash }}
      immwrt-hash: ${{ steps.set_hash.outputs.immwrt-hash }}
      libwrt-hash: ${{ steps.set_hash.outputs.libwrt-hash }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“ éªŒè¯ç›®å½•ç»“æ„
        run: |
          echo "ğŸ” å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ” GITHUB_WORKSPACE: ${{ github.workspace }}"
          echo ""
          echo "ğŸ“ æ ¹ç›®å½•ç»“æ„ï¼š"
          ls -la
          echo ""
          echo "ğŸ“ configsç›®å½•å†…å®¹ï¼š"
          if [ -d "configs" ]; then
            ls -la configs/
          else
            echo "âŒ configsç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          echo ""
          echo "ğŸ“ scriptsç›®å½•å†…å®¹ï¼š"
          if [ -d "scripts" ]; then
            ls -la scripts/
          else
            echo "âŒ scriptsç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ğŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´ (å®˜æ–¹Action)
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            
            console.log('ğŸ” åˆå§‹ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š');
            execSync('df -h', { stdio: 'inherit' });
            
            console.log('');
            console.log('ğŸ§¹ å¼€å§‹æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶...');
            
            // æ¸…ç†å‘½ä»¤åˆ—è¡¨
            const cleanupCommands = [
              'sudo docker system prune -af --volumes || true',
              'sudo apt-get clean',
              'sudo apt-get autoremove -y',
              'sudo rm -rf /usr/share/dotnet',
              'sudo rm -rf /opt/ghc',
              'sudo rm -rf /usr/local/share/boost',
              'sudo rm -rf "$AGENT_TOOLSDIRECTORY"',
              'sudo journalctl --vacuum-time=1d',
              'sudo find /var/log -type f -delete',
              'sudo rm -rf /tmp/*',
              'sudo rm -rf /var/tmp/*',
              'sudo rm -rf ~/.cache',
              'sudo rm -rf /var/cache/*'
            ];
            
            // æ‰§è¡Œæ¸…ç†å‘½ä»¤
            cleanupCommands.forEach(cmd => {
              try {
                console.log(`æ‰§è¡Œ: ${cmd}`);
                execSync(cmd, { stdio: 'inherit' });
              } catch (error) {
                console.log(`å‘½ä»¤å¤±è´¥: ${cmd}`);
              }
            });
            
            console.log('');
            console.log('âœ… æ¸…ç†å®Œæˆï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µï¼š');
            execSync('df -h', { stdio: 'inherit' });

      - name: ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_SHORT=${{ matrix.branch }}" >> $GITHUB_ENV
          echo "SOC_NAME=ipq60xx" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +'%Y%m%d')" >> $GITHUB_ENV
          
          if [[ "${{ matrix.branch }}" == "openwrt" ]]; then
            echo "REPO_URL=${{ env.REPO_OPENWRT }}" >> $GITHUB_ENV
          elif [[ "${{ matrix.branch }}" == "immwrt" ]]; then
            echo "REPO_URL=${{ env.REPO_IMMWRT }}" >> $GITHUB_ENV
          else
            echo "REPO_URL=${{ env.REPO_LIBWRT }}" >> $GITHUB_ENV
          fi

      - name: ğŸ” è®¡ç®—åŸºç¡€é…ç½®å“ˆå¸Œ
        id: calc_hash
        run: |
          echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "configs/base_${SOC_NAME}.config" ]; then
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: configs/base_${SOC_NAME}.config"
            echo "ğŸ“ configsç›®å½•å†…å®¹ï¼š"
            ls -la configs/ || echo "configsç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "configs/base_${REPO_SHORT}.config" ]; then
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: configs/base_${REPO_SHORT}.config"
            echo "ğŸ“ configsç›®å½•å†…å®¹ï¼š"
            ls -la configs/ || echo "configsç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è®¡ç®—å“ˆå¸Œå€¼
          HASH=$(sha256sum configs/base_${SOC_NAME}.config configs/base_${REPO_SHORT}.config | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "${{ matrix.branch }}=${{ steps.calc_hash.outputs.hash }}" >> hashes.txt

      - name: ğŸ’¾ ç¼“å­˜åŸºç¡€ç¯å¢ƒ
        uses: actions/cache@v4
        with:
          path: |
            build/${{ matrix.branch }}/
            dl/
            feeds/
          key: base-${{ matrix.branch }}-${{ steps.calc_hash.outputs.hash }}
          restore-keys: |
            base-${{ matrix.branch }}-

      - name: ğŸš€ å‡†å¤‡åŸºç¡€ç¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ“¦ ä¸º ${{ matrix.branch }} å‡†å¤‡åŸºç¡€ç¯å¢ƒ..."
          chmod +x scripts/*.sh
          ./scripts/build.sh prepare-base

      - name: ğŸ“¤ ä¸Šä¼ å“ˆå¸Œæ–‡ä»¶
        if: matrix.branch == 'libwrt'
        uses: actions/upload-artifact@v4
        with:
          name: hashes-file
          path: hashes.txt

  # ========================================
  # é˜¶æ®µäºŒï¼šåœ¨åŸºç¡€ç¯å¢ƒä¸Šç¼–è¯‘æœ€ç»ˆå›ºä»¶
  # ========================================
  build-firmware:
    needs: prepare-base-environments
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        branch: [openwrt, immwrt, libwrt]
        config: [Pro, Max, Ultra]
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´ (å®˜æ–¹Action)
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            
            console.log('ğŸ” åˆå§‹ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š');
            execSync('df -h', { stdio: 'inherit' });
            
            console.log('');
            console.log('ğŸ§¹ å¼€å§‹æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶...');
            
            // æ¸…ç†å‘½ä»¤åˆ—è¡¨
            const cleanupCommands = [
              'sudo docker system prune -af --volumes || true',
              'sudo apt-get clean',
              'sudo apt-get autoremove -y',
              'sudo rm -rf /usr/share/dotnet',
              'sudo rm -rf /opt/ghc',
              'sudo rm -rf /usr/local/share/boost',
              'sudo rm -rf "$AGENT_TOOLSDIRECTORY"',
              'sudo journalctl --vacuum-time=1d',
              'sudo find /var/log -type f -delete',
              'sudo rm -rf /tmp/*',
              'sudo rm -rf /var/tmp/*',
              'sudo rm -rf ~/.cache',
              'sudo rm -rf /var/cache/*'
            ];
            
            // æ‰§è¡Œæ¸…ç†å‘½ä»¤
            cleanupCommands.forEach(cmd => {
              try {
                console.log(`æ‰§è¡Œ: ${cmd}`);
                execSync(cmd, { stdio: 'inherit' });
              } catch (error) {
                console.log(`å‘½ä»¤å¤±è´¥: ${cmd}`);
              }
            });
            
            console.log('');
            console.log('âœ… æ¸…ç†å®Œæˆï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µï¼š');
            execSync('df -h', { stdio: 'inherit' });

      - name: ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è¿‡å½“å‰çŸ©é˜µä»»åŠ¡
        id: check_skip
        run: |
          # æ£€æŸ¥æ‰‹åŠ¨è§¦å‘æ—¶çš„è¾“å…¥å‚æ•°ï¼Œå†³å®šæ˜¯å¦è·³è¿‡å½“å‰çŸ©é˜µä»»åŠ¡
          SKIP_BUILD=false
          
          # å¦‚æœæ‰‹åŠ¨æŒ‡å®šäº†åˆ†æ”¯ï¼Œä¸”ä¸ç­‰äºå½“å‰çŸ©é˜µåˆ†æ”¯ï¼Œåˆ™è·³è¿‡
          if [[ "${{ github.event.inputs.branch }}" != "" && "${{ github.event.inputs.branch }}" != "${{ matrix.branch }}" ]]; then
            SKIP_BUILD=true
          fi
          
          # å¦‚æœæ‰‹åŠ¨æŒ‡å®šäº†é…ç½®ï¼Œä¸”ä¸ç­‰äºå½“å‰çŸ©é˜µé…ç½®ï¼Œåˆ™è·³è¿‡
          if [[ "${{ github.event.inputs.config }}" != "" && "${{ github.event.inputs.config }}" != "${{ matrix.config }}" ]]; then
            SKIP_BUILD=true
          fi
          
          echo "skip=$SKIP_BUILD" >> $GITHUB_OUTPUT
          
          if [[ "$SKIP_BUILD" == "true" ]]; then
            echo "â­ï¸ è·³è¿‡æ„å»º: ${{ matrix.branch }}-${{ matrix.config }}"
          else
            echo "ğŸ”¨ å¼€å§‹æ„å»º: ${{ matrix.branch }}-${{ matrix.config }}"
          fi

      - name: ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡
        if: steps.check_skip.outputs.skip == 'false'
        run: |
          echo "REPO_SHORT=${{ matrix.branch }}" >> $GITHUB_ENV
          echo "SOC_NAME=ipq60xx" >> $GITHUB_ENV
          echo "CONFIG_LEVEL=${{ matrix.config }}" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +'%Y%m%d')" >> $GITHUB_ENV
          
          if [[ "${{ matrix.branch }}" == "openwrt" ]]; then
            echo "REPO_URL=${{ env.REPO_OPENWRT }}" >> $GITHUB_ENV
          elif [[ "${{ matrix.branch }}" == "immwrt" ]]; then
            echo "REPO_URL=${{ env.REPO_IMMWRT }}" >> $GITHUB_ENV
          else
            echo "REPO_URL=${{ env.REPO_LIBWRT }}" >> $GITHUB_ENV
          fi

      - name: ğŸ“¥ ä¸‹è½½å“ˆå¸Œæ–‡ä»¶
        if: steps.check_skip.outputs.skip == 'false'
        uses: actions/download-artifact@v4
        with:
          name: hashes-file
          path: .

      - name: ğŸ” è¯»å–å¯¹åº”åˆ†æ”¯çš„å“ˆå¸Œå€¼
        id: get_hash
        if: steps.check_skip.outputs.skip == 'false'
        run: |
          # ä»æ–‡ä»¶ä¸­è¯»å–å¯¹åº”åˆ†æ”¯çš„å“ˆå¸Œå€¼
          HASH=$(grep "^${{ matrix.branch }}=" hashes.txt | cut -d'=' -f2)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "ğŸ”‘ Retrieved hash for ${{ matrix.branch }}: $HASH"

      - name: ğŸ’¾ æ¢å¤åŸºç¡€ç¯å¢ƒç¼“å­˜
        if: steps.check_skip.outputs.skip == 'false'
        uses: actions/cache@v4
        with:
          path: |
            build/${{ matrix.branch }}/
            dl/
            feeds/
          # ä½¿ç”¨ä¸Šä¸€æ­¥è¯»å–çš„å“ˆå¸Œå€¼
          key: base-${{ matrix.branch }}-${{ steps.get_hash.outputs.hash }}

      - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
        if: steps.check_skip.outputs.skip == 'false'
        run: |
          chmod +x scripts/*.sh
          ./scripts/build.sh build-firmware

      - name: ğŸ“Š æ˜¾ç¤ºç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
        if: always() && steps.check_skip.outputs.skip == 'false'
        run: |
          echo "=========================================="
          echo "ğŸ“Š ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ"
          echo "=========================================="
          df -h
          free -h
          echo "=========================================="

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_skip.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.branch }}-${{ matrix.config }}
          path: |
            output/
            logs/
          retention-days: 7
