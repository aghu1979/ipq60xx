name: OpenWrt Multi-Branch Build (Layered)

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å‘¨äº”0ç‚¹ (UTCæ—¶é—´å‘¨å››16ç‚¹)
    - cron: '0 16 * * 4'
  workflow_dispatch:
    inputs:
      branch_filter:
        description: 'é€‰æ‹©è¦ç¼–è¯‘çš„åˆ†æ”¯ (ç•™ç©ºç¼–è¯‘å…¨éƒ¨)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - openwrt
          - immwrt
          - libwrt
      config_filter:
        description: 'é€‰æ‹©é…ç½®ç±»åž‹ (ç•™ç©ºç¼–è¯‘å…¨éƒ¨)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - Ultra
          - Max
          - Pro

env:
  # å›¾æ ‡å®šä¹‰
  ICON_SUCCESS: "âœ…"
  ICON_ERROR: "âŒ"
  ICON_WARNING: "âš ï¸"
  ICON_INFO: "â„¹ï¸"
  ICON_START: "ðŸš€"
  ICON_END: "ðŸ"
  ICON_PROGRESS: "â³"
  ICON_DEBUG: "ðŸ”"
  ICON_CONFIG: "âš™ï¸"
  ICON_PACKAGE: "ðŸ“¦"
  ICON_CACHE: "ðŸ’¾"
  ICON_BUILD: "ðŸ”¨"
  ICON_CLEAN: "ðŸ§¹"
  # åŸºç¡€çŽ¯å¢ƒå˜é‡
  TZ: Asia/Shanghai
  DIY_P1_SH: scripts/diy.sh
  UPLOAD_BIN_DIR: ./upload

jobs:
  # ä½œä¸š1: è®¾ç½®çŽ¯å¢ƒï¼Œæå–è®¾å¤‡ä¿¡æ¯ï¼Œç”ŸæˆåŠ¨æ€ç¼–è¯‘çŸ©é˜µ
  setup:
    runs-on: ubuntu-22.04
    outputs:
      devices: ${{ steps.extract-devices.outputs.devices }}
      # è¾“å‡ºä¸‰ä¸ªé˜¶æ®µçš„çŸ©é˜µ
      matrix-ultra: ${{ steps.generate-matrix.outputs.matrix-ultra }}
      matrix-max: ${{ steps.generate-matrix.outputs.matrix-max }}
      matrix-pro: ${{ steps.generate-matrix.outputs.matrix-pro }}
      build-date: ${{ steps.get-date.outputs.date }}
    steps:
      - name: ${{ env.ICON_START }} æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ${{ env.ICON_CONFIG }} æå–è®¾å¤‡åˆ—è¡¨
        id: extract-devices
        run: |
          echo -e "${ICON_PROGRESS} æ­£åœ¨ä»Ž configs/base_ipq60xx.config æå–è®¾å¤‡åˆ—è¡¨..."
          DEVICES=$(grep -oE 'CONFIG_TARGET_DEVICE_.*_DEVICE_([^=]+)=y' configs/base_ipq60xx.config | sed -E 's/CONFIG_TARGET_DEVICE_.*_DEVICE_([^=]+)=y/\1/' | sort -u | tr '\n' ' ')
          if [ -z "$DEVICES" ]; then
            echo -e "${ICON_ERROR} é”™è¯¯: æœªèƒ½ä»Ž base_ipq60xx.config ä¸­æå–åˆ°ä»»ä½•è®¾å¤‡åç§°ã€‚"
            exit 1
          fi
          echo -e "${ICON_INFO} å‘çŽ°è®¾å¤‡: ${DEVICES}"
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT

      - name: ${{ env.ICON_CONFIG }} ç”ŸæˆåŠ¨æ€ç¼–è¯‘çŸ©é˜µ
        id: generate-matrix
        run: |
          # ä»Žè¾“å…¥ä¸­èŽ·å–ç”¨æˆ·é€‰æ‹©çš„è¿‡æ»¤æ¡ä»¶
          BRANCH_FILTER="${{ github.event.inputs.branch_filter || 'all' }}"
          CONFIG_FILTER="${{ github.event.inputs.config_filter || 'all' }}"
          
          # å®šä¹‰æ‰€æœ‰åˆ†æ”¯
          ALL_BRANCHES='[
            {"name": "openwrt", "repo": "https://github.com/laipeng668/openwrt.git", "branch": "master", "short": "openwrt"},
            {"name": "immwrt", "repo": "https://github.com/laipeng668/immortalwrt.git", "branch": "master", "short": "immwrt"},
            {"name": "libwrt", "repo": "https://github.com/laipeng668/openwrt-6.x.git", "branch": "k6.12-nss", "short": "libwrt"}
          ]'
          
          # å®šä¹‰æ‰€æœ‰é…ç½®
          ALL_CONFIGS='["Ultra", "Max", "Pro"]'
          
          # ç”ŸæˆåŸºç¡€çŸ©é˜µï¼ˆæ‰€æœ‰ç»„åˆï¼‰
          BASE_MATRIX=$(jq -n \
            --argjson branches "$ALL_BRANCHES" \
            --argjson configs "$ALL_CONFIGS" \
            --arg devices "${{ steps.extract-devices.outputs.devices }}" \
            '{
              include: [
                $branches[] | select($branch_filter == "all" or .short == $branch_filter) as $branch |
                $configs[] | select($config_filter == "all" or . == $config_filter) as $config |
                ($devices | split(" ") | map(select(length > 0)))[] as $device |
                {branch: $branch, config: $config, device: $device}
              ]
            }')
          
          # åˆ†ç¦»ä¸åŒé…ç½®çš„çŸ©é˜µ
          MATRIX_ULTRA=$(echo "$BASE_MATRIX" | jq '{include: [.include[] | select(.config == "Ultra")]}')
          MATRIX_MAX=$(echo "$BASE_MATRIX" | jq '{include: [.include[] | select(.config == "Max")]}')
          MATRIX_PRO=$(echo "$BASE_MATRIX" | jq '{include: [.include[] | select(.config == "Pro")]}')
          
          # è¾“å‡ºçŸ©é˜µï¼ˆç¡®ä¿æ ¼å¼æ­£ç¡®ï¼‰
          echo "matrix-ultra=$(echo "$MATRIX_ULTRA" | jq -c .)" >> $GITHUB_OUTPUT
          echo "matrix-max=$(echo "$MATRIX_MAX" | jq -c .)" >> $GITHUB_OUTPUT
          echo "matrix-pro=$(echo "$MATRIX_PRO" | jq -c .)" >> $GITHUB_OUTPUT
          
          echo -e "${ICON_INFO} Ultra çŸ©é˜µ:"
          echo "$MATRIX_ULTRA" | jq .
          echo -e "${ICON_INFO} Max çŸ©é˜µ:"
          echo "$MATRIX_MAX" | jq .
          echo -e "${ICON_INFO} Pro çŸ©é˜µ:"
          echo "$MATRIX_PRO" | jq .

      - name: ${{ env.ICON_INFO }} èŽ·å–æž„å»ºæ—¥æœŸ
        id: get-date
        run: |
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

  # ç¬¬ä¸€é˜¶æ®µ: ç¼–è¯‘ Ultra é…ç½®
  build-ultra:
    needs: setup
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix-ultra) }}
    
    steps:
      - name: ${{ env.ICON_START }} æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ${{ env.ICON_CACHE }} ç¼“å­˜æºç 
        uses: actions/cache@v3
        id: cache-source
        with:
          path: openwrt
          key: ${{ matrix.branch.short }}-source-${{ hashFiles(format('{0}/{1}', github.workspace, '.github/workflows/build.yml')) }}
          restore-keys: |
            ${{ matrix.branch.short }}-source-

      - name: ${{ env.ICON_PACKAGE }} å…‹éš†æºç 
        if: steps.cache-source.outputs.cache-hit != 'true'
        run: |
          echo -e "${ICON_PROGRESS} å…‹éš† ${{ matrix.branch.name }} æºç ..."
          git clone ${{ matrix.branch.repo }} -b ${{ matrix.branch.branch }} openwrt
          cd openwrt
          echo "æºç ç‰ˆæœ¬: $(git rev-parse --short HEAD)" > ../source_info.txt
          echo "åˆ†æ”¯: ${{ matrix.branch.branch }}" >> ../source_info.txt
          echo -e "${ICON_SUCCESS} æºç å…‹éš†å®Œæˆ"

      - name: ${{ env.ICON_CACHE }} ç¼“å­˜ Ultra å±‚çº§
        uses: actions/cache@v3
        id: cache-ultra
        with:
          path: |
            openwrt/staging_dir
            openwrt/build_dir
            openwrt/feeds
            openwrt/dl
          # Ultra ç¼“å­˜é”®ï¼ŒåŒ…å«æ‰€æœ‰é…ç½®
          key: ${{ matrix.branch.short }}-ultra-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Ultra.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
          restore-keys: |
            ${{ matrix.branch.short }}-ultra-
            ${{ matrix.branch.short }}-tools-

      - name: ${{ env.ICON_CONFIG }} åˆå¹¶ Ultra é…ç½®
        run: |
          echo -e "${ICON_PROGRESS} åˆå¹¶ Ultra é…ç½®: ${{ matrix.branch.short }}-${{ matrix.device }}-Ultra"
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p temp_config
          
          # æŒ‰ä¼˜å…ˆçº§åˆå¹¶é…ç½®
          cat configs/base_ipq60xx.config > temp_config/merged.config
          cat configs/base_${{ matrix.branch.short }}.config >> temp_config/merged.config
          cat configs/Ultra.config >> temp_config/merged.config
          
          # æå–è®¾å¤‡é…ç½®
          DEVICE_CONFIG_LINE=$(grep -E "CONFIG_TARGET_DEVICE.*_${{ matrix.device }}=y" temp_config/merged.config || true)
          if [ -z "$DEVICE_CONFIG_LINE" ]; then
            echo -e "${ICON_ERROR} é”™è¯¯: è®¾å¤‡ '${{ matrix.device }}' åœ¨é…ç½®ä¸­æœªæ‰¾åˆ°"
            exit 1
          fi
          
          # ç”Ÿæˆæœ€ç»ˆé…ç½®
          cat > openwrt/.config << EOF
          CONFIG_TARGET_${{ matrix.branch.short }}=y
          CONFIG_TARGET_${{ matrix.branch.short }}_ipq60xx=y
          CONFIG_TARGET_MULTI_PROFILE=y
          $DEVICE_CONFIG_LINE
          EOF
          
          # æ·»åŠ å…¶ä»–é…ç½®
          grep -vE "CONFIG_TARGET_DEVICE" temp_config/merged.config >> openwrt/.config
          sort -u openwrt/.config -o openwrt/.config
          
          echo -e "${ICON_SUCCESS} Ultra é…ç½®åˆå¹¶å®Œæˆ"

      - name: ${{ env.ICON_PACKAGE }} æ›´æ–°å’Œå®‰è£…Feeds
        if: steps.cache-ultra.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          echo -e "${ICON_PROGRESS} æ›´æ–° feeds..."
          ./scripts/feeds update -a
          echo -e "${ICON_PROGRESS} å®‰è£… feeds..."
          ./scripts/feeds install -a
          echo -e "${ICON_SUCCESS} Feeds å¤„ç†å®Œæˆ"

      - name: ${{ env.ICON_BUILD }} æ‰§è¡ŒDIYè„šæœ¬
        if: steps.cache-ultra.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          chmod +x ../${{ env.DIY_P1_SH }}
          ../${{ env.DIY_P1_SH }} ${{ matrix.branch.short }} ipq60xx

      - name: ${{ env.ICON_BUILD }} ä¸‹è½½å·¥å…·é“¾å’Œä¾èµ–
        if: steps.cache-ultra.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -exec rm -f {} \;

      - name: ${{ env.ICON_BUILD }} ç¼–è¯‘ Ultra å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "${ICON_BUILD} ç¼–è¯‘ Ultra å›ºä»¶ (ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹)..."
          make -j$(nproc) || make -j1 V=s
          echo -e "${ICON_SUCCESS} Ultra å›ºä»¶ç¼–è¯‘å®Œæˆ"
          
          # èŽ·å–å†…æ ¸ç‰ˆæœ¬
          KERNEL_VERSION=$(grep "CONFIG_LINUX_VERSION=" .config | cut -d'"' -f2)
          echo "kernel_version=$KERNEL_VERSION" >> $GITHUB_OUTPUT

      - name: ${{ env.ICON_PACKAGE }} æ•´ç† Ultra äº§å‡ºç‰©
        id: organize
        run: |
          echo -e "${ICON_PROGRESS} æ•´ç† Ultra äº§å‡ºç‰©..."
          TEMP_BUILD_DIR="build_artifacts/${{ matrix.branch.short }}-${{ matrix.device }}-Ultra"
          mkdir -p "$TEMP_BUILD_DIR"
          
          # å¤åˆ¶å›ºä»¶
          find openwrt/bin/targets/ -name "*${{ matrix.device }}*squashfs*" -type f | while read -r file; do
            if [[ "$file" == *factory.bin || "$file" == *sysupgrade.bin ]]; then
              FILE_TYPE=$(basename "$file" | grep -oE "(factory|sysupgrade)")
              NEW_NAME="${{ matrix.branch.short }}-${{ matrix.device }}-${FILE_TYPE}-Ultra.bin"
              cp "$file" "$TEMP_BUILD_DIR/$NEW_NAME"
              echo -e "${ICON_PACKAGE} å›ºä»¶: $NEW_NAME"
            fi
          done
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp openwrt/.config "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Ultra.config"
          cp openwrt/bin/targets/*/manifest "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Ultra.manifest" 2>/dev/null || true
          cp openwrt/config.buildinfo "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Ultra.config.buildinfo" 2>/dev/null || true
          
          # æ”¶é›†IPKåŒ…
          mkdir -p "packages_temp/${{ matrix.branch.short }}"
          find openwrt/bin/packages/ -name "*.ipk" -exec cp {} "packages_temp/${{ matrix.branch.short }}/" \; 2>/dev/null || true
          
          echo "temp_dir=$TEMP_BUILD_DIR" >> $GITHUB_OUTPUT

      - name: ${{ env.ICON_CACHE }} ä¸Šä¼  Ultra æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.branch.short }}-${{ matrix.device }}-Ultra
          path: ${{ steps.organize.outputs.temp_dir }}
          retention-days: 7

  # ç¬¬äºŒé˜¶æ®µ: ç¼–è¯‘ Max é…ç½®
  build-max:
    needs: [setup, build-ultra]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix-max) }}
    
    steps:
      - name: ${{ env.ICON_START }} æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ${{ env.ICON_CACHE }} ç¼“å­˜æºç 
        uses: actions/cache@v3
        id: cache-source
        with:
          path: openwrt
          key: ${{ matrix.branch.short }}-source-${{ hashFiles(format('{0}/{1}', github.workspace, '.github/workflows/build.yml')) }}
          restore-keys: |
            ${{ matrix.branch.short }}-source-

      - name: ${{ env.ICON_CACHE }} å¤ç”¨ Ultra ç¼“å­˜
        uses: actions/cache@v3
        id: cache-max
        with:
          path: |
            openwrt/staging_dir
            openwrt/build_dir
            openwrt/feeds
            openwrt/dl
          # Max ç¼“å­˜é”®ï¼Œå¤ç”¨ Ultra ç¼“å­˜
          key: ${{ matrix.branch.short }}-max-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Max.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
          restore-keys: |
            ${{ matrix.branch.short }}-ultra-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Ultra.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
            ${{ matrix.branch.short }}-ultra-
            ${{ matrix.branch.short }}-tools-

      - name: ${{ env.ICON_CONFIG }} åˆå¹¶ Max é…ç½®
        run: |
          echo -e "${ICON_PROGRESS} åˆå¹¶ Max é…ç½®: ${{ matrix.branch.short }}-${{ matrix.device }}-Max"
          mkdir -p temp_config
          
          # æŒ‰ä¼˜å…ˆçº§åˆå¹¶é…ç½®
          cat configs/base_ipq60xx.config > temp_config/merged.config
          cat configs/base_${{ matrix.branch.short }}.config >> temp_config/merged.config
          cat configs/Max.config >> temp_config/merged.config
          
          # æå–è®¾å¤‡é…ç½®
          DEVICE_CONFIG_LINE=$(grep -E "CONFIG_TARGET_DEVICE.*_${{ matrix.device }}=y" temp_config/merged.config || true)
          if [ -z "$DEVICE_CONFIG_LINE" ]; then
            echo -e "${ICON_ERROR} é”™è¯¯: è®¾å¤‡ '${{ matrix.device }}' åœ¨é…ç½®ä¸­æœªæ‰¾åˆ°"
            exit 1
          fi
          
          # ç”Ÿæˆæœ€ç»ˆé…ç½®
          cat > openwrt/.config << EOF
          CONFIG_TARGET_${{ matrix.branch.short }}=y
          CONFIG_TARGET_${{ matrix.branch.short }}_ipq60xx=y
          CONFIG_TARGET_MULTI_PROFILE=y
          $DEVICE_CONFIG_LINE
          EOF
          
          # æ·»åŠ å…¶ä»–é…ç½®
          grep -vE "CONFIG_TARGET_DEVICE" temp_config/merged.config >> openwrt/.config
          sort -u openwrt/.config -o openwrt/.config
          
          echo -e "${ICON_SUCCESS} Max é…ç½®åˆå¹¶å®Œæˆ"

      - name: ${{ env.ICON_BUILD }} æ‰§è¡ŒDIYè„šæœ¬
        if: steps.cache-max.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          chmod +x ../${{ env.DIY_P1_SH }}
          ../${{ env.DIY_P1_SH }} ${{ matrix.branch.short }} ipq60xx

      - name: ${{ env.ICON_BUILD }} ç¼–è¯‘ Max å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "${ICON_BUILD} ç¼–è¯‘ Max å›ºä»¶ (å¤ç”¨ Ultra ç¼“å­˜)..."
          make defconfig
          make -j$(nproc) || make -j1 V=s
          echo -e "${ICON_SUCCESS} Max å›ºä»¶ç¼–è¯‘å®Œæˆ"

      - name: ${{ env.ICON_PACKAGE }} æ•´ç† Max äº§å‡ºç‰©
        id: organize
        run: |
          echo -e "${ICON_PROGRESS} æ•´ç† Max äº§å‡ºç‰©..."
          TEMP_BUILD_DIR="build_artifacts/${{ matrix.branch.short }}-${{ matrix.device }}-Max"
          mkdir -p "$TEMP_BUILD_DIR"
          
          # å¤åˆ¶å›ºä»¶
          find openwrt/bin/targets/ -name "*${{ matrix.device }}*squashfs*" -type f | while read -r file; do
            if [[ "$file" == *factory.bin || "$file" == *sysupgrade.bin ]]; then
              FILE_TYPE=$(basename "$file" | grep -oE "(factory|sysupgrade)")
              NEW_NAME="${{ matrix.branch.short }}-${{ matrix.device }}-${FILE_TYPE}-Max.bin"
              cp "$file" "$TEMP_BUILD_DIR/$NEW_NAME"
              echo -e "${ICON_PACKAGE} å›ºä»¶: $NEW_NAME"
            fi
          done
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp openwrt/.config "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Max.config"
          cp openwrt/bin/targets/*/manifest "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Max.manifest" 2>/dev/null || true
          cp openwrt/config.buildinfo "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Max.config.buildinfo" 2>/dev/null || true
          
          echo "temp_dir=$TEMP_BUILD_DIR" >> $GITHUB_OUTPUT

      - name: ${{ env.ICON_CACHE }} ä¸Šä¼  Max æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.branch.short }}-${{ matrix.device }}-Max
          path: ${{ steps.organize.outputs.temp_dir }}
          retention-days: 7

  # ç¬¬ä¸‰é˜¶æ®µ: ç¼–è¯‘ Pro é…ç½®
  build-pro:
    needs: [setup, build-max]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix-pro) }}
    
    steps:
      - name: ${{ env.ICON_START }} æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ${{ env.ICON_CACHE }} ç¼“å­˜æºç 
        uses: actions/cache@v3
        id: cache-source
        with:
          path: openwrt
          key: ${{ matrix.branch.short }}-source-${{ hashFiles(format('{0}/{1}', github.workspace, '.github/workflows/build.yml')) }}
          restore-keys: |
            ${{ matrix.branch.short }}-source-

      - name: ${{ env.ICON_CACHE }} å¤ç”¨ Max ç¼“å­˜
        uses: actions/cache@v3
        id: cache-pro
        with:
          path: |
            openwrt/staging_dir
            openwrt/build_dir
            openwrt/feeds
            openwrt/dl
          # Pro ç¼“å­˜é”®ï¼Œå¤ç”¨ Max ç¼“å­˜
          key: ${{ matrix.branch.short }}-pro-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Pro.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
          restore-keys: |
            ${{ matrix.branch.short }}-max-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Max.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
            ${{ matrix.branch.short }}-ultra-${{ hashFiles('configs/base_ipq60xx.config', 'configs/base_*.config', 'configs/Ultra.config') }}-${{ hashFiles('openwrt/feeds.conf.default') }}
            ${{ matrix.branch.short }}-ultra-
            ${{ matrix.branch.short }}-max-
            ${{ matrix.branch.short }}-tools-

      - name: ${{ env.ICON_CONFIG }} åˆå¹¶ Pro é…ç½®
        run: |
          echo -e "${ICON_PROGRESS} åˆå¹¶ Pro é…ç½®: ${{ matrix.branch.short }}-${{ matrix.device }}-Pro"
          mkdir -p temp_config
          
          # æŒ‰ä¼˜å…ˆçº§åˆå¹¶é…ç½®
          cat configs/base_ipq60xx.config > temp_config/merged.config
          cat configs/base_${{ matrix.branch.short }}.config >> temp_config/merged.config
          cat configs/Pro.config >> temp_config/merged.config
          
          # æå–è®¾å¤‡é…ç½®
          DEVICE_CONFIG_LINE=$(grep -E "CONFIG_TARGET_DEVICE.*_${{ matrix.device }}=y" temp_config/merged.config || true)
          if [ -z "$DEVICE_CONFIG_LINE" ]; then
            echo -e "${ICON_ERROR} é”™è¯¯: è®¾å¤‡ '${{ matrix.device }}' åœ¨é…ç½®ä¸­æœªæ‰¾åˆ°"
            exit 1
          fi
          
          # ç”Ÿæˆæœ€ç»ˆé…ç½®
          cat > openwrt/.config << EOF
          CONFIG_TARGET_${{ matrix.branch.short }}=y
          CONFIG_TARGET_${{ matrix.branch.short }}_ipq60xx=y
          CONFIG_TARGET_MULTI_PROFILE=y
          $DEVICE_CONFIG_LINE
          EOF
          
          # æ·»åŠ å…¶ä»–é…ç½®
          grep -vE "CONFIG_TARGET_DEVICE" temp_config/merged.config >> openwrt/.config
          sort -u openwrt/.config -o openwrt/.config
          
          echo -e "${ICON_SUCCESS} Pro é…ç½®åˆå¹¶å®Œæˆ"

      - name: ${{ env.ICON_BUILD }} æ‰§è¡ŒDIYè„šæœ¬
        if: steps.cache-pro.outputs.cache-hit != 'true'
        run: |
          cd openwrt
          chmod +x ../${{ env.DIY_P1_SH }}
          ../${{ env.DIY_P1_SH }} ${{ matrix.branch.short }} ipq60xx

      - name: ${{ env.ICON_BUILD }} ç¼–è¯‘ Pro å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "${ICON_BUILD} ç¼–è¯‘ Pro å›ºä»¶ (å¤ç”¨ Max ç¼“å­˜)..."
          make defconfig
          make -j$(nproc) || make -j1 V=s
          echo -e "${ICON_SUCCESS} Pro å›ºä»¶ç¼–è¯‘å®Œæˆ"

      - name: ${{ env.ICON_PACKAGE }} æ•´ç† Pro äº§å‡ºç‰©
        id: organize
        run: |
          echo -e "${ICON_PROGRESS} æ•´ç† Pro äº§å‡ºç‰©..."
          TEMP_BUILD_DIR="build_artifacts/${{ matrix.branch.short }}-${{ matrix.device }}-Pro"
          mkdir -p "$TEMP_BUILD_DIR"
          
          # å¤åˆ¶å›ºä»¶
          find openwrt/bin/targets/ -name "*${{ matrix.device }}*squashfs*" -type f | while read -r file; do
            if [[ "$file" == *factory.bin || "$file" == *sysupgrade.bin ]]; then
              FILE_TYPE=$(basename "$file" | grep -oE "(factory|sysupgrade)")
              NEW_NAME="${{ matrix.branch.short }}-${{ matrix.device }}-${FILE_TYPE}-Pro.bin"
              cp "$file" "$TEMP_BUILD_DIR/$NEW_NAME"
              echo -e "${ICON_PACKAGE} å›ºä»¶: $NEW_NAME"
            fi
          done
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp openwrt/.config "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Pro.config"
          cp openwrt/bin/targets/*/manifest "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Pro.manifest" 2>/dev/null || true
          cp openwrt/config.buildinfo "$TEMP_BUILD_DIR/${{ matrix.branch.short }}-${{ matrix.device }}-Pro.config.buildinfo" 2>/dev/null || true
          
          echo "temp_dir=$TEMP_BUILD_DIR" >> $GITHUB_OUTPUT

      - name: ${{ env.ICON_CACHE }} ä¸Šä¼  Pro æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.branch.short }}-${{ matrix.device }}-Pro
          path: ${{ steps.organize.outputs.temp_dir }}
          retention-days: 7

  # ä½œä¸š4: æ•´ç†æ‰€æœ‰äº§ç‰©å¹¶å‘å¸ƒRelease
  release:
    needs: [setup, build-ultra, build-max, build-pro]
    runs-on: ubuntu-22.04
    if: always() && (needs.build-ultra.result == 'success' || needs.build-max.result == 'success' || needs.build-pro.result == 'success')
    steps:
      - name: ${{ env.ICON_START }} æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ${{ env.ICON_PACKAGE }} ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          path: all_builds

      - name: ${{ env.ICON_PACKAGE }} æ•´ç†å‘å¸ƒåŒ…
        run: |
          echo -e "${ICON_PROGRESS} æ•´ç†æœ€ç»ˆå‘å¸ƒåŒ…..."
          
          # åˆ›å»ºå‘å¸ƒç›®å½•ç»“æž„
          RELEASE_DIR="release_${{ needs.setup.outputs.build-date }}"
          mkdir -p "$RELEASE_DIR"/{firmware,config,logs,packages}
          
          # 1. æ•´ç†å›ºä»¶
          find all_builds -name "*.bin" -type f -exec cp {} "$RELEASE_DIR/firmware/" \;
          
          # 2. æ•´ç†é…ç½®æ–‡ä»¶
          find all_builds -name "*.config" -o -name "*.manifest" -o -name "*.config.buildinfo" | while read -r file; do
            cp "$file" "$RELEASE_DIR/config/"
          done
          # æ‰“åŒ…é…ç½®æ–‡ä»¶
          cd "$RELEASE_DIR/config"
          tar -czf "../ipq60xx-config.tar.gz" *
          cd - > /dev/null
          
          # 3. æ•´ç†è½¯ä»¶åŒ…
          find all_builds -name "*.ipk" -type f -exec cp {} "$RELEASE_DIR/packages/" \;
          cd "$RELEASE_DIR/packages"
          tar -czf "../ipq60xx-app.tar.gz" *
          cd - > /dev/null
          
          # 4. åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
          cat > "$RELEASE_DIR/README.md" << EOF
          # OpenWrt å›ºä»¶å‘å¸ƒ - ${{ needs.setup.outputs.build-date }}
          
          ## ðŸ“Œ åŸºæœ¬ä¿¡æ¯
          - **é»˜è®¤ç®¡ç†åœ°å€**: \`192.168.111.1\`
          - **é»˜è®¤ç”¨æˆ·**: \`root\`
          - **é»˜è®¤å¯†ç **: \`none\` (ç•™ç©º)
          - **é»˜è®¤WIFIå¯†ç **: \`12345678\`
          
          ## ðŸ“¦ å›ºä»¶ä¿¡æ¯
          - **ç¼–è¯‘åˆ†æ”¯**: openwrt, immwrt, libwrt
          - **æ”¯æŒè®¾å¤‡**: ${{ needs.setup.outputs.devices }}
          - **é…ç½®ç±»åž‹**: Pro (ç²¾ç®€), Max (æ ‡å‡†), Ultra (å®Œæ•´)
          - **å†…æ ¸ç‰ˆæœ¬**: ä»Žå›ºä»¶ä¸­èŽ·å–
          - **ä½œè€…**: Mary
          - **å‘å¸ƒæ—¶é—´**: ${{ needs.setup.outputs.build-date }}
          
          ## ðŸ“‚ æ–‡ä»¶è¯´æ˜Ž
          - \`firmware/\`: å„è®¾å¤‡å„é…ç½®çš„å›ºä»¶æ–‡ä»¶
          - \`ipq60xx-config.tar.gz\`: æ‰€æœ‰è®¾å¤‡çš„é…ç½®ã€æ¸…å•å’Œæž„å»ºä¿¡æ¯åŽ‹ç¼©åŒ…
          - \`ipq60xx-app.tar.gz\`: æœ¬æ¬¡ç¼–è¯‘åŒ…å«çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…
          
          ## ðŸ·ï¸ å›ºä»¶å‘½åè§„åˆ™
          \`åˆ†æ”¯ç¼©å†™-è®¾å¤‡åç§°-ç±»åž‹(factory/sysupgrade)-é…ç½®(Pro/Max/Ultra).bin\`
          
          ---
          _ç”± GitHub Actions è‡ªåŠ¨æž„å»º (åˆ†å±‚ç¼–è¯‘æ¨¡å¼)_
          EOF
          
          echo -e "${ICON_SUCCESS} å‘å¸ƒåŒ…æ•´ç†å®Œæˆ"

      - name: ${{ env.ICON_PACKAGE }} åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ipq60xx-${{ needs.setup.outputs.build-date }}
          name: OpenWrt Multi-Branch Build ${{ needs.setup.outputs.build-date }}
          body_path: release_${{ needs.setup.outputs.build-date }}/README.md
          files: |
            release_${{ needs.setup.outputs.build-date }}/firmware/*.bin
            release_${{ needs.setup.outputs.build-date }}/ipq60xx-*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ${{ env.ICON_SUCCESS }} ç¼–è¯‘å®Œæˆé€šçŸ¥
        run: |
          echo -e "${ICON_SUCCESS} ${ICON_SUCCESS} ${ICON_SUCCESS}"
          echo -e "æ‰€æœ‰å›ºä»¶åˆ†å±‚ç¼–è¯‘å¹¶å‘å¸ƒæˆåŠŸï¼"
          echo -e "${ICON_INFO} å‘å¸ƒæ ‡ç­¾: ipq60xx-${{ needs.setup.outputs.build-date }}"
          echo -e "${ICON_INFO} è¯·è®¿é—® Releases é¡µé¢ä¸‹è½½ã€‚"
